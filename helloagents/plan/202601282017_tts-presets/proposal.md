# 变更提案: tts-presets

## 元信息
```yaml
类型: 新功能
方案类型: implementation
优先级: P1
状态: 草稿
创建: 2026-01-28
```

---

## 1. 需求

### 背景
语音生成需要支持可配置参数与预设管理，方便不同场景选择更合适的音色与语音风格，同时保证默认值与当前服务一致。

### 目标
- 提供全局 TTS 预设配置（可新增/编辑/启用/停用）
- 语音生成时可选择预设并支持自定义参数
- 默认预设为当前 TTS 服务默认参数

### 约束条件
```yaml
时间约束: 无
性能约束: 批量生成仍需并发请求
兼容性约束: 现有 TTS 接口不破坏
业务约束: 参数范围需按约束校验
```

### 验收标准
- [ ] 媒体规则页新增 TTS 预设管理，可新增/编辑/停用/删除
- [ ] 语音生成支持选择预设与自定义参数（滑动条），并按范围校验
- [ ] 默认预设参数与当前服务默认值一致

---

## 2. 方案

### 技术方案
- 新增 `app_db_tts_presets` 表存储全局预设（含默认值）
- 新增 `/api/tts/presets` CRUD 接口（管理员维护）
- 前端媒体规则页新增“语音预设”配置页
- TTS 生成面板支持预设下拉 + 参数滑动条，生成请求携带参数

### 影响范围
```yaml
涉及模块:
  - server: 新增预设表与接口
  - web: 预设配置页、TTS 生成参数
预计变更文件: 12-18
```

### 风险评估
| 风险 | 等级 | 应对 |
|------|------|------|
| 默认值不一致导致语音风格变化 | 中 | 以 tts 服务默认参数初始化预设 |
| 参数范围误填导致生成失败 | 中 | 前端滑动条 + 后端范围校验 |

---

## 3. 技术设计（可选）

### 架构设计
```mermaid
flowchart TD
    A[MediaRules: TTS预设] --> B[app_db_tts_presets]
    C[TTS生成面板] --> D[/api/tts/convert]
    C --> A
```

### API设计
#### GET /api/tts/presets
- **响应**: 预设列表（含默认标记与参数）

#### POST /api/tts/presets
- **请求**: {name, voice_id, volume, speed, pitch, stability, similarity, exaggeration, status, is_default}
- **响应**: 新增结果

### 数据模型
| 字段 | 类型 | 说明 |
|------|------|------|
| id | int | 主键 |
| name | varchar | 预设名称 |
| voice_id | varchar | 语音 ID |
| volume | int | 0-100 |
| speed | decimal | 0.5-2.0 |
| pitch | int | 1-100 |
| stability | int | 0-100 |
| similarity | int | 0-100 |
| exaggeration | int | 0-100 |
| status | tinyint | 启用/停用 |
| is_default | tinyint | 默认预设 |

---

## 4. 核心场景

### 场景: 选择预设生成语音
**模块**: 内容录入 / TTS 生成
**条件**: 已配置至少 1 个预设
**行为**: 选择预设并生成语音，可手动调整参数
**结果**: 生成语音文件并写入本地路径

---

## 5. 技术决策

### tts-presets#D001: 预设存储方式
**日期**: 2026-01-28
**状态**: ✅采纳
**背景**: 需要长期维护多套 TTS 参数方案
**选项分析**:
| 选项 | 优点 | 缺点 |
|------|------|------|
| A: 复用 app_db_media_rules | 无需新表 | 语义不清、字段耦合 |
| B: 新增 app_db_tts_presets | 结构清晰、便于扩展 | 需新增表与接口 |
**决策**: 选择方案B
**理由**: 预设与媒体规则职责不同，独立表更清晰可维护
**影响**: server / web / migrations
